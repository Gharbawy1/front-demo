<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout — Multi Items + Metadata (Appointment Test)</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 16px; direction:ltr; }
    label { display:block; margin-top:12px; font-weight:600; }
    input, select, button, textarea { width:100%; padding:8px; margin-top:6px; box-sizing:border-box; }
    .row { display:flex; gap:12px; }
    .row > * { flex:1; }
    .small { width:120px; }
    .status { margin-top:12px; padding:10px; border-radius:6px; display:none; }
    .status.success { background:#e6ffed; color:#0a6b2b; display:block; }
    .status.error { background:#ffe6e6; color:#8a0a0a; display:block; }
    .spinner { display:inline-block; width:14px; height:14px; border:2px solid #ccc; border-top-color:#333; border-radius:50%; animation:spin 0.9s linear infinite; vertical-align:middle; margin-left:8px; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .items-list { margin-top:8px; border:1px dashed #ccc; padding:8px; border-radius:6px; background:#f9f9f9; }
    .item { padding:12px; border:1px solid #ddd; border-radius:6px; margin-bottom:12px; background:white; position:relative; }
    .remove-item { position:absolute; top:8px; right:8px; background:red; color:white; border:none; width:24px; height:24px; border-radius:50%; cursor:pointer; font-weight:bold; }
    textarea { height:100px; font-family: monospace; }
    .add-btn { background:#007bff; color:white; padding:10px; border:none; cursor:pointer; margin-top:8px; }
  </style>
</head>
<body>

  <h1>Checkout — Multi Items + Metadata (Appointment Ready)</h1>
  <p>استخدم بطاقة اختبار: <code>4111 1111 1111 1111</code> | Exp: <code>12/30</code> | CVV: <code>123</code></p>

  <script>
    const CONFIG = {
      apiLoginID: "25pQwt2Vd",
      clientKey: "95n56trhr7Cg4cvFMSEjtWL2P9K7m4685G7HQ3mtJGVTW2FSCcbd8TNRCMat5z9x",
      payEndpoint: "https://localhost:7204/api/Pay"
    };
  </script>

  <script type="text/javascript" src="https://jstest.authorize.net/v1/Accept.js"></script>

  <form id="paymentForm" autocomplete="off">
    <h3>Customer / Billing</h3>
    <label>First name <input id="firstName" required value="Ahmed"/></label>
    <label>Last name <input id="lastName" required value="Youssef"/></label>
    <label>Contact (email or mobile) <input id="contactInfo" required value="+201001234567"/></label>
    <label>Address <input id="address" value="123 Nile Street"/></label>

    <div class="row">
      <label>City <input id="city" value="Cairo"/></label>
      <label>State <input id="state" value="Cairo"/></label>
    </div>
    <div class="row">
      <label>County <input id="county" value="Nasr City"/></label>
      <label>Country <input id="country" value="Egypt"/></label>
    </div>
    <label>Zip <input id="zip" value="11765"/></label>

    <h3>Card Info</h3>
    <label>Card number <input id="cardNumber" placeholder="4111 1111 1111 1111" required /></label>
    <div class="row">
      <label>Exp Month <input id="expMonth" class="small" placeholder="12" required /></label>
      <label>Exp Year <input id="expYear" class="small" placeholder="2030" required /></label>
      <label>CVV <input id="cvv" class="small" placeholder="123" required /></label>
    </div>

    <h3>Promo Code</h3>
    <label>Promo Code (optional) <input id="promoCode" placeholder="PROMO123"/></label>

    <h3>Order Items</h3>
    <div class="items-list" id="itemsList">
      <!-- Items will be added here -->
    </div>
    <button type="button" class="add-btn" id="addItemBtn">+ Add Item</button>

    <h3>Metadata (for Appointment)</h3>
    <label>
      Metadata (JSON string) - للحجز
      <textarea id="metadata" placeholder='{"appointment_branch_id": "6d70ea40-f098-4f8d-8796-022a28c95e00", "appointment_date": "2025-11-08", "appointment_time": "12:00:00"}'>
{
  "appointment_branch_id": "6d70ea40-f098-4f8d-8796-022a28c95e00",
  "appointment_date": "2025-11-08",
  "appointment_time": "12:00:00"
}
      </textarea>
    </label>

    <button id="payBtn" type="button" style="margin-top:20px; padding:12px; font-size:18px;">Pay now</button>
    <div id="status" class="status"></div>
  </form>

  <script>
  (function () {
    const payBtn = document.getElementById('payBtn');
    const statusEl = document.getElementById('status');
    const itemsList = document.getElementById('itemsList');
    const addItemBtn = document.getElementById('addItemBtn');
    const AUTH_BEARER = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuYW1laWQiOiI4NjM2YWE4Yy1jYTI1LTRkMmQtYWNlYS02NDM5ZjI4YmJhNTQiLCJlbWFpbCI6ImFkbWluQGdhaGJpei5jb20iLCJnaXZlbl9uYW1lIjoiYWRtaW5AZ2FoYml6LmNvbSIsInJvbGUiOiJBZG1pbiIsIm5iZiI6MTc2MjExMTg5NywiZXhwIjoxNzYyNzE2Njk3LCJpYXQiOjE3NjIxMTE4OTcsImlzcyI6Imh0dHBzOi8vbG9jYWxob3N0OjcxMDEiLCJhdWQiOiJodHRwczovL2xvY2FsaG9zdDo3MTAxIn0.tGBtPSh1USkiQ8WCLo-20-OJWX6wikY-0IfKmhDvd40";

    // Default items (زي اللي عايزه)
    const defaultItems = [
      {
        serviceId: "9defe476-1fdb-4050-a15b-a1e04985d854",
        name: "Appointment",
        price: 10,
        quantity: 1,
        deliveryType: "Online",
        shipping: false
      },
      {
        serviceId: "b076b52d-f06b-44fc-8979-1dec159b1b0a",
        name: "Book Written test",
        price: 1250,
        quantity: 1,
        deliveryType: "Online",
        shipping: false
      }
    ];

    function createItemHTML(item = {}) {
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `
        <button type="button" class="remove-item" onclick="this.parentElement.remove()">×</button>
        <label>Service ID <input class="serviceId" value="${item.serviceId || ''}" /></label>
        <label>Name <input class="itemName" value="${item.name || ''}" /></label>
        <div class="row">
          <label>Price (USD) <input class="itemPrice" type="number" step="0.01" value="${item.price || 0}" /></label>
          <label>Quantity <input class="itemQty" type="number" min="1" value="${item.quantity || 1}" /></label>
        </div>
        <div class="row">
          <label>Delivery Type <input class="deliveryType" value="${item.deliveryType || 'Online'}" /></label>
          <label>Shipping?
            <select class="shipping">
              <option value="true" ${item.shipping ? 'selected' : ''}>true</option>
              <option value="false" ${!item.shipping ? 'selected' : ''}>false</option>
            </select>
          </label>
        </div>
      `;
      return div;
    }

    // Load default items
    defaultItems.forEach(item => itemsList.appendChild(createItemHTML(item)));

    addItemBtn.onclick = () => itemsList.appendChild(createItemHTML());

    function showStatus(msg, type = 'error') {
      statusEl.className = 'status ' + (type === 'success' ? 'success' : 'error');
      statusEl.innerHTML = msg;
    }
    function clearStatus() { statusEl.className = 'status'; statusEl.innerHTML = ''; }
    function setLoading(on) {
      payBtn.disabled = on;
      payBtn.innerHTML = on ? 'Processing <span class="spinner"></span>' : 'Pay now';
    }

    function buildSecureData() {
      return {
        authData: { clientKey: CONFIG.clientKey, apiLoginID: CONFIG.apiLoginID },
        cardData: {
          cardNumber: document.getElementById('cardNumber').value.replace(/\s+/g, ''),
          month: document.getElementById('expMonth').value,
          year: document.getElementById('expYear').value,
          cardCode: document.getElementById('cvv').value
        }
      };
    }

    function collectItems() {
      const items = [];
      document.querySelectorAll('.item').forEach(el => {
        const serviceId = el.querySelector('.serviceId').value.trim();
        if (!serviceId) return;
        items.push({
          serviceId,
          name: el.querySelector('.itemName').value.trim(),
          price: parseFloat(el.querySelector('.itemPrice').value) || 0,
          quantity: parseInt(el.querySelector('.itemQty').value) || 1,
          deliveryType: el.querySelector('.deliveryType').value.trim(),
          shipping: el.querySelector('.shipping').value === 'true'
        });
      });
      return items;
    }

    function createRequestPayload(opaqueDataValue) {
      const metadataText = document.getElementById('metadata').value.trim();
      let metadata = null;
      if (metadataText) {
        try { metadata = metadataText; } // هيبعت كـ string
        catch (e) { throw new Error("Invalid JSON in metadata"); }
      }

      return {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        address: document.getElementById('address').value.trim(),
        country: document.getElementById('country').value.trim(),
        state: document.getElementById('state').value.trim(),
        county: document.getElementById('county').value.trim(),
        city: document.getElementById('city').value.trim(),
        zip: document.getElementById('zip').value.trim(),
        contactInfo: document.getElementById('contactInfo').value.trim(),
        cardToken: opaqueDataValue,
        promoCode: document.getElementById('promoCode').value.trim() || null,
        metadata: metadata, // JSON string
        items: collectItems()
      };
    }

    async function postOrder(payload) {
      try {
        const res = await fetch(CONFIG.payEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + AUTH_BEARER
          },
          body: JSON.stringify(payload)
        });
        const text = await res.text();
        try { return { ok: res.ok, status: res.status, body: JSON.parse(text) }; }
        catch { return { ok: res.ok, status: res.status, body: { raw: text } }; }
      } catch (err) {
        return { ok: false, body: { error: err.message } };
      }
    }

    function acceptResponseHandler(response) {
      console.log("Accept.js response:", response);
      if (!response?.opaqueData?.dataValue) {
        setLoading(false);
        showStatus("Tokenization failed: " + (response?.messages?.message?.[0]?.text || "Unknown error"), "error");
        return;
      }

      const payload = createRequestPayload(response.opaqueData.dataValue);
      console.log("Sending to backend:", payload);

      postOrder(payload).then(result => {
        setLoading(false);
        if (result.ok && result.body.Success) {
          showStatus(`Payment SUCCESS! Order ID: ${result.body.OrderId} | Appointment Booked!`, "success");
        } else {
          showStatus("Payment failed: " + (result.body.Error || JSON.stringify(result.body)), "error");
        }
      });
    }

    payBtn.onclick = () => {
      clearStatus();
      setLoading(true);
      try {
        Accept.dispatchData(buildSecureData(), acceptResponseHandler);
      } catch (ex) {
        setLoading(false);
        showStatus("Accept.js error: " + ex.message, "error");
      }
    };

  })();
  </script>
</body>
</html>